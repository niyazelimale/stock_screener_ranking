{% extends 'analyzer/base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 text-center">
        <h1 class="display-4 fw-bold text-primary">Market Scanner Dashboard</h1>
        <p class="lead text-muted">Real-time analysis of multiple Chartink screeners</p>
    </div>
</div>

<!-- Action Section -->
<div class="row justify-content-center mb-5">
    <div class="col-md-8 text-center">
        <button id="startScanBtn" class="btn btn-primary btn-lg px-5 py-3 shadow-sm">
            <i class="bi bi-play-circle-fill me-2"></i>Start New Scan
        </button>
        <p id="statusText" class="mt-3 text-muted">Ready to scan</p>
    </div>
</div>


<!-- Progress Bar (Hidden by default) -->
<div class="row justify-content-center mb-5" id="progressContainer" style="display: none;">
    <div class="col-md-8">
        <div class="progress shadow-sm">
            <div id="scanProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                role="progressbar" style="width: 0%"></div>
        </div>
        <div id="logContainer" class="mt-2 p-2 bg-light border rounded"
            style="height: 100px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; color: #555;">
            Waiting for logs...
        </div>
    </div>
</div>

<!-- High Conviction Results -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-white py-3 border-0">
                <h4 class="mb-0 fw-bold">
                    <i class="bi bi-star-fill text-warning me-2"></i>High Conviction Stocks
                    <span class="badge bg-primary ms-2">{{ high_conviction_count }}</span>
                    <span class="badge bg-light text-dark border ms-2" style="font-size: 0.7rem;">Rank â‰¥ {{ threshold }}</span>
                </h4>
            </div>
            <div class="card-body">
                {% if recent_job %}
                <p class="text-muted small">Last Scan: {{ recent_job.completed_at|timesince }} ago</p>
                {% endif %}

                {% if high_conviction_stocks %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Symbol</th>
                                <th>Price</th>
                                <th>Volume</th>
                                <th>Ranking</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock in high_conviction_stocks %}
                            <tr>
                                <td class="fw-bold">
                                    <a href="https://in.tradingview.com/chart/Tlvo7NTQ/?symbol=NSE:{{ stock.symbol }}"
                                        target="_blank" class="text-decoration-none text-primary">
                                        {{ stock.symbol }} <i class="bi bi-box-arrow-up-right small"
                                            style="font-size: 0.7em;"></i>
                                    </a>
                                </td>
                                <td>{{ stock.close_price }}</td>
                                <td>{{ stock.volume }}</td>
                                <td>
                                    <span class="badge bg-success rounded-pill">{{ stock.screener_count }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <a href="{% url 'result_detail' recent_job.id %}" class="btn btn-outline-primary">View Full
                        Results</a>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                    No high conviction stocks found in the last scan.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        let jobId = null;
        let pollInterval = null;

        $('#startScanBtn').click(function () {
            // Disable button
            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Starting...');
            $('#progressContainer').show();
            $('#statusText').text("Initializing scan...");
            $('#scanProgressBar').css('width', '5%').removeClass('bg-danger').addClass('bg-success');

            // Trigger Scan
            $.post("{% url 'start_scan' %}", {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function (data) {
                if (data.status === 'success') {
                    jobId = data.job_id;
                    pollInterval = setInterval(checkStatus, 2000);
                } else {
                    alert("Failed to start scan: " + data.message);
                    resetUI();
                }
            }).fail(function () {
                alert("Server error connecting to scan API.");
                resetUI();
            });
        });

        function checkStatus() {
            if (!jobId) return;

            $.get("/analyzer/api/status/" + jobId, function (data) {
                // Update Progress
                let width = data.progress + "%";
                $('#scanProgressBar').css('width', width);
                $('#statusText').text(data.status + " (" + width + ")");

                // Update Logs (last line)
                let lines = data.log.split('\n');
                let lastLine = lines[lines.length - 2] || lines[lines.length - 1]; // Handle trailing newline
                if (lastLine) $('#logContainer').text(lastLine);

                if (data.status === 'COMPLETED') {
                    clearInterval(pollInterval);
                    $('#statusText').text("Scan Completed successfully!");
                    $('#startScanBtn').prop('disabled', false).html('<i class="bi bi-play-circle-fill me-2"></i>Start New Scan');
                    setTimeout(function () {
                        location.reload(); // Reload to show results
                    }, 1000);
                } else if (data.status === 'FAILED') {
                    clearInterval(pollInterval);
                    $('#statusText').text("Scan Failed.");
                    $('#scanProgressBar').removeClass('bg-success').addClass('bg-danger');
                    $('#startScanBtn').prop('disabled', false).html('<i class="bi bi-play-circle-fill me-2"></i>Retry Scan');
                }
            });
        }

        function resetUI() {
            $('#startScanBtn').prop('disabled', false).html('<i class="bi bi-play-circle-fill me-2"></i>Start New Scan');
            $('#progressContainer').hide();
        }
    });
</script>
{% endblock %}